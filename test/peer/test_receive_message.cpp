#include "doctest/doctest.h"
#include "core/peer/protocol/MessageHeader.h"
#include "core/peer/protocol/decoders/MessageDecoder.h"
#include <vector>
#include <cstdint>

/**
 * @brief Tests pour la réception et le décodage de messages
 * 
 * Ces tests vérifient :
 * - Le décodage du header (TYPE + NONCE)
 * - La validation du header
 * - La gestion des messages invalides
 */

TEST_CASE("Should decode valid public message") {
    // USER_MESSAGE complet: Header (19 bytes) + Payload (144 bytes)
    // Header: TYPE (1) + NONCE (2) + RECIPIENT_ID (16) = 19 bytes
    // Payload: SESSION_ID (16) + CONTENT (128) = 144 bytes
    std::vector<uint8_t> data = {
        // Header: TYPE=0x07, NONCE=0x1234, RECIPIENT_ID (public = 16 bytes de 0x00)
        0x07, 0x12, 0x34,  // TYPE + NONCE
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // RECIPIENT_ID (public)
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        // Payload: SESSION_ID="session-1" (9 bytes + 7 padding)
        0x73, 0x65, 0x73, 0x73, 0x69, 0x6F, 0x6E, 0x2D, 0x31, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        // CONTENT="hi" (2 bytes + 126 padding)
        0x68, 0x69,  // "hi"
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };
    MessageDecoder decoder;
    MessageInterface* message = decoder.decode(data);
    CHECK(message != nullptr);
    CHECK(message->getType() == 0x07);
    CHECK(message->getNonce() == 0x1234);
    CHECK(message->getPayloadSize() == 144);  // 16 (SESSION_ID) + 128 (CONTENT)
    delete message;
}

TEST_CASE("Should decode valid private message") {
    // USER_MESSAGE privé: Header (19 bytes) + Payload (144 bytes)
    // Header: TYPE (1) + NONCE (2) + RECIPIENT_ID (16) = 19 bytes
    // Payload: SESSION_ID (16) + CONTENT (128) = 144 bytes
    std::vector<uint8_t> data = {
        // Header: TYPE=0x07, NONCE=0x5678, RECIPIENT_ID="recipient-1" (11 bytes + 5 padding)
        0x07, 0x56, 0x78,  // TYPE + NONCE
        0x72, 0x65, 0x63, 0x69, 0x70, 0x69, 0x65, 0x6E, 0x74, 0x2D, 0x31, 0x00, 0x00, 0x00, 0x00, 0x00,  // RECIPIENT_ID="recipient-1"
        // Payload: SESSION_ID="session-1" (9 bytes + 7 padding)
        0x73, 0x65, 0x73, 0x73, 0x69, 0x6F, 0x6E, 0x2D, 0x31, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        // CONTENT="hi" (2 bytes + 126 padding)
        0x68, 0x69,  // "hi"
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };
    MessageDecoder decoder;
    MessageInterface* message = decoder.decode(data);
    CHECK(message != nullptr);
    CHECK(message->getType() == 0x07);
    CHECK(message->getNonce() == 0x5678);
    CHECK(message->getPayloadSize() == 144);  // 16 (SESSION_ID) + 128 (CONTENT)
    delete message;
}

TEST_CASE("Should reject message that contains no payload") {
    // Message trop court: seulement 1 byte (TYPE), besoin de 3 bytes minimum pour header standard
    std::vector<uint8_t> data = {0x04};
    MessageDecoder decoder;
    MessageInterface* message = decoder.decode(data);
    CHECK(message == nullptr);
    delete message;
}

TEST_CASE("Should reject message with unknown type") {
    std::vector<uint8_t> data = {0x08, 0x12, 0x34};  // Type inconnu 0x08 avec nonce
    MessageDecoder decoder;
    MessageInterface* message = decoder.decode(data);
    CHECK(message == nullptr);
}

